---
title: "COVID-19 Data Analysis Project: Do vaccines really work?"
author: "(Xiquan Jiang, 920268566)"
date: "(03/13/2022)"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
# Introduction

<font face="Times New Roman" size=4>
Corona virus disease pandemic not only affects the global politics and economy, but also profoundly and comprehensively affects all aspects of society and life. In people's cognition, vaccines should play a role in block the spread of corona virus disease. However, whether people get vaccinated can prevent the spread of corona virus requires data support and more research. Also, if the strong correlation between the current epidemic development and the vaccination rate can be studied, and the higher the vaccination rate, the more stable and less severe the epidemic will be in the future, then it will be more convincing to encourage people to get fully vaccinated. This project obtained data from who's website, including the Latest reported counts of cases and deaths, WHO COVID 19 global data and vaccination data, and set hypothesis that current epidemic situations have a difference between vaccination level and number of vaccine types, there is association between current epidemic situations and country vaccination level, and the number of 1 dose vaccinated people causes newly cases to Granger-cause itself. This report combines past news and research to provide a reasonable explanation for the conclusions reached by this project.
</font>

# Data background

<font face="Times New Roman" size=4>
In adults, the Oxford/AstraZeneca vaccine had 70% efficacy against COVID-19 >14 d after the 2nd dose (Zain Chagla, 2021) However, it is possible that vaccines won't necessarily work to prevent the spread of corona virus. A two-dose regimen of the ChAdOx1 nCoV-19 vaccine did not show protection against mild-to-moderate Covid-19 due to the B.1.351 variant (Madhi, Shabir A. etal., 2021). Also, incorrect vaccines are likely to cause people to get sick or even die, which in turn contributes to the development of the epidemic. Although people have accumulated a lot of experience in vaccine research for infectious diseases before, vaccines for the severe acute respiratory syndrome (SARS), Ebola, and Zika did not follow a similar path(Fernando P. Polack, 2020). Moreover, the research and development process of vaccines is very expensive and will encounter many challenges, so it is worth studying and discussing whether it is worthwhile to encourage people to get vaccinated and whether it will prevent the development of the epidemic. 

The [Latest reported counts of cases and deaths](https://covid19.who.int/WHO-COVID-19-global-table-data.csv) (02/17/2022) was obtained from WHO, and there are 237 records and 12 variables. 

|  Variable name   | Description  |
|  ----  | ----  |
| `Name`  | Country, territory, area |
| `WHO.Region`  | WHO Region |
| `Cases - cumulative total`  | Cumulative confirmed cases. |
| `Cases - cumulative total per 100000 population`  | Cumulative confirmed cases per 100,000 population. |
| `Cases - newly reported in last 7 days`  | New confirmed cases reported in the last 7 days. |
| `Cases - newly reported in last 7 days per 100000 population	`  | New confirmed cases reported in the last 7 days per 100,000 population. |
| `Cases - newly reported in last 24 hours`  | New confirmed cases in the last 24 hours. |
| `Deaths - cumulative total`  | Cumulative confirmed deaths. |
| `Deaths - cumulative total per 100000 population`  | Cumulative confirmed deaths per 100,000 population. |
| `Deaths - newly reported in last 7 days`  | New confirmed deaths reported in the last 7 days. |
| `Deaths - newly reported in last 7 days per 100000 population`  | New confirmed deaths reported in the last 7 days per 100,000 population. |
| `Deaths - newly reported in last 24 hours`  | New confirmed deaths reported in the last 24 hours. |

The [WHO COVID 19 global data](https://covid19.who.int/WHO-COVID-19-global-data.csv) (to 02/17/2022)contains 184,149 records and 8 variables

|  Variable name   | Description  |
|  ----  | ----  |
| `Date_reported`  | Date of reporting to WHO |
| `Country_code	`  | ISO Alpha-2 country code |
| `Country`  | Country, territory, area |
| `WHO_region`  | WHO regional offices: |
| `New_cases`  | New confirmed cases |
| `Cumulative_cases`  | Cumulative confirmed cases |
| `New_deaths`  | New confirmed deaths |
| `Cumulative_deaths`  | Cumulative confirmed deaths |

The [Vaccination data](https://covid19.who.int/who-data/vaccination-data.csv) which contains 228 records and 14 variables was achieved from WHO. 

|  Variable name   | Description  |
|  ----  | ----  |
| `COUNTRY`  | Country, territory, area |
| `ISO3	`  | ISO Alpha-3 country code |
| `WHO_REGION`  | WHO Region |
| `DATA_SOURCE`  | Indicates data source |
| `DATE_UPDATED`  | Date of last update |
| `TOTAL_VACCINATIONS`  | Cumulative total vaccine doses administered |
| `PERSONS_VACCINATED_1PLUS_DOSE`  | Cumulative number of persons vaccinated with at least one dose |
| `TOTAL_VACCINATIONS_PER100`  | Cumulative total vaccine doses administered per 100 population |
| `PERSONS_VACCINATED_1PLUS_DOSE_PER100`  | Cumulative persons vaccinated with at least one dose per 100 population |
| `PERSONS_FULLY_VACCINATED	`  | Cumulative number of persons fully vaccinated |
| `PERSONS_FULLY_VACCINATED_PER100	`  | Cumulative number of persons fully vaccinated per 100 population |
| `VACCINES_USED`  | Combined short name of vaccine |
| `FIRST_VACCINE_DATE`  | Date of first vaccinations |
| `NUMBER_VACCINES_TYPES_USED`  | Number of vaccine types used per country, territory, area |
</font>

# Questions of interest
<font face="Times New Roman" size=4>
Firstly, we will conduct descriptive analysis to achieve basic global epidemic and vaccine situation and epidemic situation in the United State. Then, we will examine the difference in Corona cases by two independent variables and assess the difference the interaction between two independent variables in two-way analysis of variance. Furthermore, we will make a Granger-causality Test used to examine if `PERSONS_VACCINATED_1PLUS_DOSE_PER100` may be used to forecast `Cases...newly.reported.in.last.7.days`. </font>

    ·  Does current epidemic situations (new confirmed cases reported in the last 7 days per 100,000 population) would have difference between vaccination level (cumulative total vaccine doses administered per 100 population) and number of vaccine types(number of vaccine types used per country, territory, area)?
    
    · Whether there is any association between current epidemic situations and country vaccination level?
    
    · Can the the values of cumulative persons vaccinated with at least one dose per 100 population predict values of new confirmed cases reported in the last 7 days per 100,000 population in the future?
    
# Descriptive analysis

## Data Preprocessing

### Missing Values
<font face="Times New Roman" size=4>
Firstly, we checked the missing values in the datasets. In the dataset of Latest reported counts of cases and deaths, there are 4 missing values, but they are all in the row which the `Name` is “Other”. There is no doubt that the population of all other countries which are not documented in the dataset is difficult and it is meaningless to study the data, which is ambiguous, so we decided to remove the whole row which the `Name` is “Other” to get a more accurate analysis and have 236 records in total. Then, we found 777 data missing in WHO COVID 19 global database, but this is only 4% of the total data and in future studies we will focuse on months as the subject, so it is reasonable to remove all missing values from our data of. After that we get 184,149 records in our data. In Vaccination data we found 15 missing data. Since the dataset was pooled from numerous sources including third-party sites, it might be incomplete. We decided to remove missing values in `PERSONS_VACCINATED_1PLUS_DOSE_PER100` which has 3 missing values and kept the missing data, if the variable which will be taken into consideration in further data analysis, we might remove. Therefore we got 222 data in Vaccine data.</font>

### Merging Data

<font face="Times New Roman" size=4>
Secondly, there are too many variables in those datasets, we merged two data set into one dataset to analyze conveniently and removed some unimportant variables which we won’t concentrated on. Then, we matched `Name` in Latest reported counts of cases and deaths data with `COUNTRY` in Vaccine data and got a dataset with 222 records. There are 12 unmatched records, but it is possible that the country name in two datasets is different. We checked those unmatched records and found that the country “Kosovo” is “Kosovo[1]” in Latest reported counts of cases and deaths data and “occupied Palestinian territory” is “occupied Palestinian territory, including east Jerusalem”. Thus, we manually modified the names of these two countries, then got 220 records in total. In order to analyze efficiently, we decided to remove some variables which we are not interested in. We will focus on epidemic of different countries and United State, so we removed `WHO.Region`, `ISO3` and  `WHO_REGION`. There are many missing values in `DATA_SOURCE`, `DATE_UPDATED`, `VACCINES_USED`, `FIRST_VACCINE_DATE` which are hard to use other information to complete, and we do not concentrate on those variables so we decided to remove them. The data we paid attention to is the cumulative cases and new reported cases in seven days (from Feb 10th 2022 to Feb 17th 2022), so we will not take `Cases...newly.reported.in.last.24.hours` and `Deaths...newly.reported.in.last.24.hours` into consideration. The population of countries are totally different and it is likely that each person need to vaccinate many times, so it might be meaningless to study `TOTAL_VACCINATIONS`. Therefore, we still have 15 variables in our dataset.</font>

```{r,include = FALSE, echo=T}
#install.packages("HH")
library(car)
#install.packages("kableExtra")
library(kableExtra)
library(stats)
library(lmtest)
covid <- read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/Latest reported counts of cases and death.csv")
vac <- read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/vaccination-data.csv")
# check NA
sum(is.na(covid))
sum(is.na(vac))

# delete NA in covid
sum(is.na(covid$`Cases - cumulative total per 100000 population`))#1 missing values
#covidc<- covid[-which(is.na(covid$`Cases - cumulative total per 100000 population`)), ]#remove those 1 missing values
sum(is.na(covid$`Cases - newly reported in last 7 days per 100000 population`))
sum(is.na(covid$`Deaths - cumulative total per 100000 population`))
sum(is.na(covid$`Deaths - newly reported in last 7 days per 100000 population`))
#238 data

#delete NA of 'PERSONS_FULLY_VACCINATED_PER100', 'TOTAL_VACCINATIONS_PER100', 'PERSONS_VACCINATED_1PLUS_DOSE_PER100', 'NUMBER_VACCINES_TYPES_USED' in vac
sum(is.na(vac$TOTAL_VACCINATIONS_PER100))
sum(is.na(vac$PERSONS_VACCINATED_1PLUS_DOSE_PER100))#3 missing values
vacc<- vac[-which(is.na(vac$PERSONS_VACCINATED_1PLUS_DOSE_PER100)), ]#remove those 3 missing values
sum(is.na(vacc$PERSONS_FULLY_VACCINATED_PER100))
sum(is.na(vacc$NUMBER_VACCINES_TYPES_USED))#3 missing values 
vacc<- vacc[-which(is.na(vacc$NUMBER_VACCINES_TYPES_USED)), ]
#222 data

#change name
covid$Name[which(covid$Name == 'Kosovo[1]')] <- "Kosovo"
covid$Name[which(covid$Name == "occupied Palestinian territory, including east Jerusalem")]<-"occupied Palestinian territory"
#merge data
data<-merge(covid,vacc,by.x = 'Name', by.y = 'COUNTRY') 
#221 data
data <- data[ , !names(data) %in% c("WHO.Region", "Cases...newly.reported.in.last.24.hours","Deaths...newly.reported.in.last.24.hours","TOTAL_VACCINATIONS","ISO3", "WHO_REGION", "DATA_SOURCE","DATE_UPDATED","VACCINES_USED","FIRST_VACCINE_DATE")]

#WHO-COVID-19-global-data
global<-read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/WHO-COVID-19-global-data.csv")
sum(is.na(global))
777/184149 
na.omit(global)
require(gridExtra)
```

<font size=3.5><center>**Fig. 1 New confirmed cases reported in the last 7 days per 100,000 population**</center></font>
```{r,echo=F,fig.align="center"}
library(plyr)
library(ggplot2)
Cases...newly.reported.in.last.7.days.per.100000.population<-arrange(data, -Cases...newly.reported.in.last.7.days.per.100000.population)
Country<-reorder(Cases...newly.reported.in.last.7.days.per.100000.population$Name,-Cases...newly.reported.in.last.7.days.per.100000.population$Cases...newly.reported.in.last.7.days.per.100000.population)
plot_1<-ggplot(Cases...newly.reported.in.last.7.days.per.100000.population,aes(x=Country,y=`Cases...newly.reported.in.last.7.days.per.100000.population`))+
  geom_point(color="black")+
  geom_line(aes(group=""), color="grey")+
  labs(x="")+
  theme(axis.title.x = element_blank(),
        axis.line.x= element_blank(),
        axis.text.x = element_blank())
plot_2 <- ggplot(data,aes(y=Cases...newly.reported.in.last.7.days.per.100000.population)) + geom_boxplot()
grid.arrange(plot_1, plot_2 ,ncol=2)
```

<font face="Times New Roman" size=4>What is more, since each country has different population and its epidemic prevention policy was also different initially, it is hard to assess each country's current epidemic situation based on the number of cumulative cases or newly reported cases in last 7 days, and we selected `Cases...newly.reported.in.last.7.days.per.100000.population` as the variable to evaluated the current epidemic situation. Then, we categorized countries into "current mild epidemic", "current moderate epidemic" and "current severe epidemic" based on the newly reported cases in last 7 days per 100000 population. According to the line chart and the box plot of new confirmed cases reported in the last 7 days per 100,000 population(*Fig.1*), we could see that some countries have extremely large number of new confirmed cases which may cause some trouble for us to categorize. Therefore, we removed some outliers of new confirmed cases, and get the mean and third quantile. As a result, if `Cases...newly.reported.in.last.7.days.per.100000.population` is less than 69.194, we define the country as "current mild epidemic". When the `Cases...newly.reported.in.last.7.days.per.100000.population` is more than 69.194 and less than 405.447, we defined the country as "current moderate epidemic". Otherwise, we identified the country as "current severe epidemic". 

Secondly, we wanted to define each country's vaccination level. It is known that after the person is vaccinated, the vaccine will produce a certain immune response in the body, and finally produce the COVID-19 Antibody. In order to easily measure the degree of vaccination between different countries, we compared the number of 1 plus dose vaccinated per 100 people. Then, based on the mean and third quantile of `PERSONS_VACCINATED_1PLUS_DOSE_PER100`, we categorized countries with `PERSONS_VACCINATED_1PLUS_DOSE_PER100` from 75.955 to 123.710 as "highly vaccinated", from 54.257 to 75.955 as "moderately vaccinated" and less than 54.257 as "lowly vaccinated".</font>

```{r,include = FALSE,echo=T}
outliers <-boxplot(data$Cases...newly.reported.in.last.7.days.per.100000.population)$out
outliers2 <-boxplot(data$Cases...newly.reported.in.last.7.days.per.100000.population)$out
cnr<- data[-which(data$Cases...newly.reported.in.last.7.days.per.100000.population %in% outliers),]
summary(cnr$Cases...newly.reported.in.last.7.days.per.100000.population)
#define countries
covidnew<-data
#summary(data$Cases...newly.reported.in.last.7.days.per.100000.population)
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population <=69.194 )] <- "current mild epidemic"#<Mean
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population < 405.447 )] <- "current moderate epidemic"#Mean-3rd Qu.
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population < 8764.97 )] <- "current severe epidemic"#>3rd Qu.
#factor(covidnew$`Cases - newly reported in last 7 days per 100000 population`)
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population ==899.484 )] <- "current severe epidemic"
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population ==898.429 )] <- "current severe epidemic"
#count(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population)

#factor(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
summary(data$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 >= 75.955 & covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 <= 123.710 )] <- "highly vaccinated"#>3rd Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 <=54.257 )] <- "lowly vaccinated"#<Mean
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 < 75.955 & covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 > 54.257)] <- "moderately vaccinated"# Mean.-3rd Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 ==8.491 )] <- "lowly vaccinated"#<1st Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 ==8.525 )] <- "lowly vaccinated"#<1st Qu.
#factor(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
count(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
```


## Data Visualizations

<font face="Times New Roman" size=4>From the bar plot of top 10 countries  with the most total cumulative cases (*Fig.2*), we concluded that the cumulative cases of United States of America is far larger than other countries and the country with the second most confirmed total cases is India. However, the country with the most cases that reported in last 7 days per 100000 population is Faeroe Islands and the second is Denmark which are not the top 10 countries' total cumulative cases. The policies which implied to prevent spread of COVID-19 initially and now may cause difference between cumulative cases and newly reported cases.Some countries might do nothing nowadays prevent COVID-19 spread and some countries still encourage people to wear masks. Also, countries with a large population base are likely to have a large cumulative number of confirmed cases.</font>

<font size=3.5><center>**Fig.2  Top 10 countries with the most total cumulative cases and newly reported cases in last 7 days per 100000 population**</center></font>
```{r,echo=F, fig.align="center"}
Cases...cumulative.total_max10<-arrange(data, -Cases...cumulative.total)[1:10,]
Country<-reorder(Cases...cumulative.total_max10$Name,-Cases...cumulative.total_max10$Cases...cumulative.total)
Cases...newly.reported.in.last.7.days.per.100000.population.max10<-arrange(data, -Cases...newly.reported.in.last.7.days.per.100000.population)[1:10,]
Country2<-reorder(Cases...newly.reported.in.last.7.days.per.100000.population.max10$Name,-Cases...newly.reported.in.last.7.days.per.100000.population.max10$Cases...newly.reported.in.last.7.days.per.100000.population)
Deaths...cumulative.total_max10<-arrange(data, -Deaths...cumulative.total)[1:10,]
#bar plot of Cases...cumulative.total_max10
plot1<-ggplot(Cases...cumulative.total_max10,aes(x=Country,y=`Cases...cumulative.total`))+
  geom_bar(stat = 'identity',position="dodge")+
  geom_col(aes(fill=Name),show.legend=F)+  
  theme(axis.text.x = element_text(angle=60,hjust=1))
#bar plot of Cases...newly.reported.in.last.7.days.per.100000.population.max10
plot2<-ggplot(Cases...newly.reported.in.last.7.days.per.100000.population.max10,aes(x=Country2,y=`Cases...newly.reported.in.last.7.days.per.100000.population`))+
  geom_bar(stat = 'identity',position="dodge")+
  geom_col(aes(fill=Name),show.legend=F)+  
  theme(axis.text.x = element_text(angle=60,hjust=1))
grid.arrange(plot1, plot2 ,ncol=2)
```

<font face="Times New Roman" size=4>From bar plot of the number of new cases and cumulative cases grouped by WHO region (*Fig.3*), it reflects that there have been 4 peak periods of newly confirmed cases in the world in the past. Among them, from December 2020 to February 2021, from April 2021 to May 2021, and from July 2021 to October 2021 were three small peaks of new confirmed cases, and from January 2022 to February 2022 the number of new confirmed cases worldwide has reached an unprecedented peak. From what we know from the news, A new variant of COVID-19 called Omicron which was first detect on November 2021 was reported to WHO. The Omicron is easier to spread than ordinary virus and Delta and people who even fully vaccinated and do not have any symptom like fever, cough or fatigue had the possibility of infecting Omicron. Therefore, it caused a rapid growth of new cases in January 2022 to February 2022. 

Furthermore, we could see that the new confirmed cases from December 2020 to February 2021 and from July 2021 to October 2021 were mainly due to the increase in Americas, the peak of newly cases from July 2021 to October 2021 mainly came from South-East Asia, and the number of confirmed cases in Western Pacific has been stable except during the period of Omicron. It is known that the first identified Delta was in late 2020, which was more likely to make people infected than original virus and caused sharp increase of new confirmed cases. Also, it could be concluded that the number of cumulative cases in Americas has been higher than in other regions and the cumulative number of confirmed cases in South-East Asia has stabilized after an extremely rapid increase in May 2021. The news related the April 2021 spike of new Covid-19 confirmed cases in South-East Asia with the increase in mobility since people traveled a lot to meet their families.
</font>

<font size=3.5><center>**Fig.3  The number of new cases and cumulative cases grouped by WHO region**</center></font>
```{r,echo=F,fig.align="center"}
global$Date_reported <- as.Date(global$Date_reported)
#number of new cases
a<-ggplot(global, aes(x=Date_reported, y=New_cases, color=WHO_region)) + 
  geom_bar(position = 'stack',stat="identity", width=0.6, color = "grey") + 
  #geom_col(position = 'stack', width = 0.6)+
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  ggtitle("new cases")

#number of cumulative cases
b<-ggplot(global, aes(x=Date_reported, y=Cumulative_cases, color=WHO_region)) + 
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  ggtitle("cumulative cases")
grid.arrange(a,b,nrow=2)
```

<font face="Times New Roman" size=4>
According to the bar plot of the number of new deaths and cumulative deaths grouped by WHO region (*Fig.4*), the end of 2020 saw a sharp increase in daily deaths, and the number of new deaths peaked so far in January 2021. The data indicated that Delta has more transmissible than the original virus and lead a significant increase in hospitalizations, but still cannot relate Delta with higher deaths. A second small spike in new daily deaths occurred between March and May 2021. 

A second small peak in new daily deaths occurred between March and May 2021, due to a surge in deaths in Southeast Asia and the Americas. This report previously discussed the high diagnosis rate caused by the mobility of people in Southeast Asia from March to May 2021. At the same time, the backward medical level of some Southeast Asian countries is very likely to be the cause of high mortality. There was a small peak in daily new deaths from August to October 2020, mainly due to a significant increase in new deaths in Europe. There was also a peak in new deaths due to omicron in January-February 2022, and now there is a downward trend.
</font>

<font size=3.5><center>**Fig.4 The number of new deaths grouped by WHO region**</center></font>
```{r,echo=F,fig.align="center"}
#number of new deaths 
ggplot(global, aes(x=Date_reported, y=New_deaths, color=WHO_region)) + 
  geom_col(position = 'stack', width = 0.6)+
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))

```



<font face="Times New Roman" size=4>The pie chart of the number of vaccine types used per country, territory, area (*Fig.5*) reflects that most countries provided 4 types vaccines(25%), 16.82% countries used 3 types vaccines and very few countries which used more than 7 types of vaccine. Therefore, we could see that the types of vaccines chosen vary widely between countries.</font>

<font size=3.5><center>**Fig.5  Distribution of the number of vaccine types used per country, territory, area**</center></font>
```{r,echo=F, fig.align="center"}
#Distribution of the number of vaccine types used per country, territory, area
par(pin = c(6,4.5))
freq <- table(data$NUMBER_VACCINES_TYPES_USED)
class<-levels(data$NUMBER_VACCINES_TYPES_USED)
piepercent <- round(freq/sum(freq)*100,2)
pie(freq,labels = paste(c("1 type:","2 types:","3 types:","4 types:","5 types:","6 types:","7 types:","8 types:","9 types:","11 types:"),piepercent,"%"))
```

<font face="Times New Roman" size=4>In order to show the figure clearly, we used the data without outliers in weekly newly reported cases. The box plot of weekly newly reported cases per 100000 and persons vaccinated 1 plus dose per 100 (*Fig.6*) shows that the number of weekly newly reported cases varies from country to country with different vaccinated level. Also, we concluded that the ranges and means of weekly newly reported cases are different based on different vaccinated level countries. However, weekly newly reported cases' average of lowly vaccinated countries is the lowest and average of highly vaccinated countries is the largest. The conclusions we reach may be contrary to our common sense, so we need to study further. Then, we used complete data to draw the box plot of persons vaccinated 1 plus dose per 100 and weekly newly reported cases per 100000, which reflects the range of persons vaccinated 1 plus dose per 100 in current mild epidemic is the largest and the mean is the lowest. The average of persons vaccinated 1 plus dose per 100 with current severe epidemic is little bit smaller than current mild epidemic.</font>

<font size=3.5><center>**Fig.6  Box plot of weekly newly reported cases per 100000 and persons vaccinated 1 plus dose per 100**</center></font>
```{r,echo=F, fig.align="center"}
cnr2<- covidnew[-which(data$Cases...newly.reported.in.last.7.days.per.100000.population %in% outliers2),]
p<-ggplot(cnr,aes(x=Cases...newly.reported.in.last.7.days.per.100000.population,y=cnr2$PERSONS_VACCINATED_1PLUS_DOSE_PER100))+geom_boxplot()+theme(axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))+geom_boxplot(aes(fill=factor(cnr2$PERSONS_VACCINATED_1PLUS_DOSE_PER100)))+
theme(legend.position="none")
q<-ggplot(data,aes(x=PERSONS_VACCINATED_1PLUS_DOSE_PER100,y=covidnew$Cases...newly.reported.in.last.7.days.per.100000.population))+geom_boxplot()+theme(axis.text.x = element_text(angle = 45, hjust = 0.5, vjust = 0.5))+geom_boxplot(aes(fill=factor(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population)))+
theme(legend.position="none")
grid.arrange(p,q,nrow=2)
```

# Inferential analysis 

```{r,include=FALSE}
# Exploratory analysis
require(dplyr)
library(gplots)
df<-data.frame(data$Cases...newly.reported.in.last.7.days.per.100000.population,covidnew[ ,names(covidnew) %in% c("PERSONS_VACCINATED_1PLUS_DOSE_PER100","NUMBER_VACCINES_TYPES_USED")])
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=as.factor(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=as.factor(df$NUMBER_VACCINES_TYPES_USED)
df <- df%>%filter(NUMBER_VACCINES_TYPES_USED!="9")
df <- df%>%filter(NUMBER_VACCINES_TYPES_USED!="11")
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=unlist(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=unlist(df$NUMBER_VACCINES_TYPES_USED)
names(df)<-c("nrc","pv1","nct")
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=unlist(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=unlist(df$NUMBER_VACCINES_TYPES_USED)
names(df)<-c("nrc","pv1","nct")
```

<font face="Times New Roman" size=4>
We combine `Cases...newly.reported.in.last.7.days.per.100000.population` and `NUMBER_VACCINES_TYPES_USED`from the complete cleaned data with `PERSONS_VACCINATED_1PLUS_DOSE_PER100` from categorized data, and renamed them as `nrc`, `pv1` and `nct` namely. Since only 1 country has 9 vaccines types and 1 country has 11 vaccines types, it might be meaningless to study them and we remove those two country.</font>

## Levene's test 

<font face="Times New Roman" size=4>
Before using analysis of variance, we need to check the homogeneity of variance through Levene's test. However, the p value is 8.903e-06 which is less than the significant level 0.05, so there is a violation of the homogeneity of variance.
</font>

<font size=3.5><center>**Table.1 Levene's Test for Homogeneity of Variance (center = median)**</center></font>
```{r,echo=F,fig.align="center"}
## Levene Test:Homogeneity of variance
dt<-leveneTest(nrc~pv1*nct,data=df)
dt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```


<font face="Times New Roman" size=4>
Thus, we need to transform data and tried log10(x)^(1/2) transformation, while log10() will transfer some data into -Inf. In the end we used log10(x+1)^(1/2) to transform data and did Levene's test again. From the table of Levene's Test for Homogeneity of Variance, it reflects that the p value  is 0.4567 which is greater than 0.05 so the homogeneity of variance can be assumed.
</font>

<font size=3.5><center>**Table.2 Levene's Test for Homogeneity of Variance (center = median)**</center></font>

```{r,echo=F,fig.align="center"}
dff<-df
dff$`nrc`<-log10(1+(dff$nrc)^(1/2))
kt<-leveneTest(nrc~pv1*nct,data=dff)
kt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

## Normality test

<font face="Times New Roman" size=4>
Then, we need to test the normality of the data through QQ-plot. Based on the QQ plots (*Fig.7*), we concluded that the normality of data can be assumed.
</font>
<font size=3.5><center>**Fig.7 QQ plots**</center></font>
```{r,echo=F,fig.align="center"}
#QQ-plot :Normality of the distribution
par(mfrow = c(1, 2))
qqPlot(lm(nrc~pv1, data = dff), simulate = TRUE, main = 'QQ Plot', labels = FALSE)
qqPlot(lm(nrc~nct, data = dff), simulate = TRUE, main = 'QQ Plot', labels = FALSE)
```

## Two-way ANOVA

<font face="Times New Roman" size=4>
According to the matrix scatter plot(*Fig.8*), there are two factors with nine combinations, so we consider two-way ANOVA model. Then, we need to check whether there are interaction effects.</font>
<font size=3.5><center>**Fig.8 Matrix scatter plot**</center></font>
```{r,echo=F, fig.align="center"}
pairs(dff,pch=16,col='grey',cex=1.5)
```

<font face="Times New Roman" size=4>
The factor effect form of two-way ANOVA is $Y_i=\mu_{..}\alpha_i+\beta_j+(\alpha\beta)_{ij}+\epsilon_{ijk}$. 

where $\epsilon_{ijk}~N(0,σ^2)$ and independent and $\begin{equation*} \sum\alpha_{i}=\sum\beta_{i}=\sum(\alpha\beta)_{ij}\end{equation*}$. 

- Means:

   $\mu{..}=\begin{equation*}\sum_{i=1}^{a}\sum_{j=1}^{b}\mu_{ij}/(ab)\end{equation*}$;
  
   $\mu{i.}=\begin{equation*}\sum_{j=1}^{b}\mu_{ij}/b\end{equation*}$;
  
   $\mu{.j}=\begin{equation*}\sum_{i=1}^{a}\mu_{ij}/a\end{equation*}$. 

- Constrains: 

  $\begin{equation*}\sum_{i=1}\alpha_{i}=\sum_{j=1}\beta_{j}=0\end{equation*}$;
  
  $\begin{equation*}\sum_{j=1}^{b}\alpha\beta_{ij}=0\end{equation*}$ for any i, i=1,...,a.
  
  $\begin{equation*}\sum_{i=1}^{a}\alpha\beta_{ij}=0\end{equation*}$ for any j, j=1,...,b;
  
- Assumptions:

  Homogeneity of variance
  
  Normality of the distribution
  
  Independence of observations
  
  Independence of samples

In this project, the dependent variable is `nrc`and independent variables are `pv1` and `nct`. Index i denotes the the country's vaccinated levels, index j denotes the types of vaccines the country used and k denotes the kth observation in treatment combinations.

According to the main effects plots (*Fig.9*), it shows differences between weekly newly reported cases per 100000 means for country vaccination level and vaccines types numbers. We see that there is a difference in between lines indicates a main effect of country vaccination level; and a difference in between lines indicates a main effect of vaccines types numbers. Also, the interaction plot indicates that weekly newly reported cases per 100000 means for country vaccination level act together to impact the weekly newly reported cases per 100000 means. The lines in the interaction plot (*Fig.10*) are not parallel but there wasn't a lot of intersection between these lines, so there might be interaction effects. Then, we need to test for the interactions.
</font>
<font size=3.5><center>**Fig.9 Main effects plots**</center></font>
```{r,echo=F, fig.align="center"}
#sum(is.na(df))
par(mfrow=c(1,2))
# Main effect plot for ingredient 1
plotmeans(nrc~pv1,data=dff,xlab="vaccination level",ylab="weekly newly cases per 100000",
          main="Main  effect, vaccination level",cex.lab=1.5) 
# Main effect plot for ingredient 2
plotmeans(nrc~nct,data=dff,xlab="vaccines types",ylab="weekly newly cases per 100000", 
          main="Main  effect, vaccines types",cex.lab=1.5) 
```
<font size=3.5><center>**Fig.10 Interaction plot**</center></font>
```{r,echo=F, fig.align="center"}
#Interaction plot
interaction.plot( dff$nct,dff$pv1, dff$nrc,cex.lab=1.5,ylab="weekly newly cases per 100000",xlab='vaccines types')
```

<font face="Times New Roman" size=4>
We made the null and alternative hypothesis:

<center>
$H_0:{\alpha\beta}_{ij}=0$;

$H_1$: not all ${\alpha\beta}_{ij}$ equal to 0
</center>

The Analysis of Variance Table indicates that the p value is 0.1471 and we could not reject the null hypothesis at the significance level of 0.05, so the interaction between two variables should be dropped.
</font>

<font size=3.5><center>**Table.3 Analysis of Variance Table**</center></font>
```{r,echo=F}
# Test for interactions 
full_model=lm(nrc~as.factor(dff$pv1)+as.factor(dff$nct)+as.factor(dff$pv1)*as.factor(dff$nct),data=dff);
reduced_model=lm(nrc~as.factor(dff$pv1)+as.factor(dff$nct),data=dff);
at<-anova(reduced_model,full_model)
at %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

<font face="Times New Roman" size=4>
We fitted the two-way ANOVA model on our dataset and set p as 0.05. The p-values are less than 0.05, which reflects that 
current epidemic situations (new confirmed cases reported in the last 7 days per 100,000 population) have difference between vaccination level (cumulative total vaccine doses administered per 100 population) and number of vaccine types(number of vaccine types used per country, territory, area), country vaccination level and vaccines types significant impact on current epidemic situations. 

Also, we want to test whether there is any association between current epidemic situations and country vaccination level. we set null and alternative hypothesis: $H_0:$ all ${\alpha}_i$ are the same and $H_1:$ not all ${\alpha}_i$ are the same; We found that F-statistics is 34.782, we can thus reject the null hypothesis at the significance level 0.05, and conclude that there is association between current epidemic situations and country vaccination level.
</font>

```{r,echo=T,include=FALSE}
# Fit the chosen model:
sig.level=0.05;
anova.fit<-aov(nrc~pv1+nct,data=dff)
summary(anova.fit)
```
<font size=3.5><center>**Table.4 Analysis of variance table**</center></font>
```{r,echo=F}
bt<- data.frame("row1" = c(" ", "Df", "Sum Sq", "Mean Sq", "F value", "Pr(>F)"), "row2" = c("pv1", "2", "14.48", "7.241", "34.782","9.31e-14 ***"))
variable = c("pv1","nct","Residuals")
Df = c(2,7,208)
Sum_Sq = c(14.48,8.30,43.30)
Mean_Sq=c(7.241,1.186,0.208)
F_value=c(34.782,5.695," ")
Pr=c("9.31e-14 ***","4.90e-06 ***"," ")
bt = data.frame(variable,Df,Sum_Sq,Mean_Sq,F_value,Pr);
bt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

# Sensitivity Analysis 

<font face="Times New Roman" size=4>
Above we came to the conclusion that current epidemic situations have difference between vaccination level and number of vaccine types using anova with no interaction term, but we still need to test whether our previous assumptions hold.
</font>

<font size=3.5><center>**Fig.11 sensitivity analysis plots**</center></font>
```{r,echo=F,fig.align="center"}
par(mfrow=c(2,2))
# Obtain the residuals from the ANOVA fit
residuals=anova.fit$residuals;
hist(residuals)
# Plot the residuals (or the other two versions) against fitted values
plot(residuals~anova.fit$fitted.values,type='p',pch=16,cex=1.5,xlab="Fitted values",ylab="Residuals")
# Stem-leaf plot  (or use histogram, or qq-plot )
qqnorm(residuals);qqline(residuals)
```
<font face="Times New Roman" size=4>
According to the histogram of residuals (*Fig.11*), we concluded that the distribution of residuals is normal. Also, the residuals vs fitted plot has no clear funnel shape so there is no major violation of the assumption. QQ-plot indicates that most of the residuals are in between -3 and 3 and residual distribution is a little bit left-skewed.
</font>

# Causal Inference

<font face="Times New Roman" size=4>
In the end, We did Granger-causality Test used to examine if `PERSONS_VACCINATED_1PLUS_DOSE_PER100` may be used to forecast `Cases...newly.reported.in.last.7.days`. We set null hypothesis that time series `PERSONS_VACCINATED_1PLUS_DOSE_PER100` does not cause time series `Cases...newly.reported.in.last.7.days` to Granger-cause itself and the alternative hypothesis is time series `PERSONS_VACCINATED_1PLUS_DOSE_PER100` cause time series `Cases...newly.reported.in.last.7.days` to Granger-cause itself.
</font>

<font size=3.5><center>**Table.5 Granger causality test table**</center></font>
```{r, echo=F}
gt<-grangertest(`Cases...newly.reported.in.last.7.days` ~ `PERSONS_VACCINATED_1PLUS_DOSE_PER100`, order = 2, data =data)
gt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```

<font face="Times New Roman" size=4>
The test’s p-value is 0.5807 so we accept the null hypothesis because this value is greater than 0.05. That is, the values of cumulative persons vaccinated with at least one dose per 100 population cannot predict the values of new confirmed cases reported in the last 7 days per 100,000 population in the future.
</font>

# Conclusion

<font face="Times New Roman" size=4>
Since the beginning of 2020, the development of the epidemic has been repeated, and every few months there is a peak of daily new confirmed cases due to the mobility of people or the emergence of new viruses. The most recent peak, the largest ever daily new cases in the past two years, is likely due to omicron, but it is encouraging to see that this peak has been declining. The daily deaths has also seen several peaks over the past two years, but it is worth noting that the value of each peak appears to be declining. We should still be optimistic about the future and expect the daily number of confirmed cases and deaths to continue to decline until Covid disappears.

From the two-way anova table, it indicates that current epidemic situations have difference between vaccination level and number of vaccine types. Also, country vaccination level and vaccines types significant impact on current epidemic situations, and all assumptions of the model hold. However, the box plots of current epidemic situations and vaccination level reflect that weekly newly reported cases' average of lowly vaccinated countries would have mild epidemic and the epidemic of highly vaccinated countries is severe. We can explain this conclusion since people in countries with high vaccination rates are highly likely to think that they do not need to maintain physical distance after being vaccinated and are reluctant to wear masks, but vaccines cannot 100% prevent the spread of Covid, leading to epidemic still serious. In countries with low vaccination rates, it is very possible that the previous epidemic was well controlled, so the number of infected people has been relatively small. We concluded that there is association between current epidemic situations and country vaccination level, but whether it is a positive or negative association remains to be further studied.

It is difficult to predict future daily new confirmed cases based on the data variables studied in this project, but it may be possible to use other variables. However, predicting the daily new confirmed cases in the future is of great help for policy formulation and stabilizing people's anxiety about corona virus. Therefore, it is necessary to select appropriate data sets and variables to predict the development of corona virus, but at the same time it is hard to predict the impact of a sudden and highly infectious virus variant such as Omicron. However, it is still worthy of investigation and research to select correct methods to fully consider the prediction of confirmed cases.
</font>

# Acknowledgement 

<font face="Times New Roman" size=4>
Bo Zhang, Cindy Li, Xinyue Hu, Sixue Chen
</font>

# Reference {-}

[1] Chagla, Z. . (2021). In adults, the oxford/astrazeneca vaccine had 70% efficacy against covid-19 >14 d after the 2nd dose. Annals of Internal Medicine.

[2] Madhi, S. A. ,  Baillie, V. ,  Cutland, C. L. ,  Voysey, M. , &  Izu, A. . (2021). Efficacy of the chadox1 ncov-19 covid-19 vaccine against the b.1.351 variant. New England Journal of Medicine.

[3] Polack, F. P. ,  Thomas, S. J. ,  Kitchin, N. ,  Absalon, J. , &  Gruber, W. C. . Safety and efficacy of the bnt162b2 mrna covid-19 vaccine. The New England journal of medicine, 383(27), 2603-2615.

[4] Lurie, N. ,  Saville, M. ,  Hatchett, R. , &  Halton, J. . (2020). Developing covid-19 vaccines at pandemic speed. New England Journal of Medicine, 382(21).

[5] Beeraka, N. M. ,  Tulimilli, S. V. ,  Karnik, M. ,  Sadhu, S. P. , &  Madhunapantula, S. V. . The current status and challenges in the development of vaccines and drugs against severe acute respiratory syndrome-corona virus-2 (sars-cov-2). BioMed research international, 2021, 8160860.

[6] Lurie, N. ,  Sharfstein, J. M. , &  Goodman, J. L. . (2020). The development of covid-19 vaccines: safeguards needed. JAMA The Journal of the American Medical Association, 324(5).

[7] Centers for Disease Control and Prevention. (n.d.). Omicron variant: What you need to know. Centers for Disease Control and Prevention. Retrieved March 13, 2022, from https://www.cdc.gov/coronavirus/2019-ncov/variants/omicron-variant.html 

[8] Centers for Disease Control and Prevention. (n.d.). Omicron variant: What you need to know. Centers for Disease Control and Prevention. Retrieved March 13, 2022, from https://www.cdc.gov/coronavirus/2019-ncov/variants/omicron-variant.html 

[9] Sasongko, T. (2021, July 19). Covid-19 in Southeast Asia: All eyes on Indonesia. PreventionWeb. Retrieved March 13, 2021, from https://www.preventionweb.net/news/covid-19-southeast-asia-all-eyes-indonesia 

[10] Hagen, A. S. H. L. E. Y. (2021, July 30). How dangerous is the delta variant (b.1.617.2)? ASM.org. Retrieved March 13, 2022, from https://asm.org/Articles/2021/July/How-Dangerous-is-the-Delta-Variant-B-1-617-2 

[11] Chen, S. (n.d.). Chapter 4 Analysis of Variance. Jupyter Notebook Viewer. Retrieved March 13, 2022, from https://nbviewer.org/github/ChenShizhe/StatDataScience/blob/master/Notes/Chapter4ANOVAII.ipynb 

[12] Chen, S. (n.d.). Chapter 9 Causal Inference. Jupyter Notebook Viewer. Retrieved March 13, 2022, from https://nbviewer.org/github/ChenShizhe/StatDataScience/blob/master/Notes/Chapter9Causal.ipynb 

[13] Sievert, C. (2019, December 19). Interactive web-based data visualization with R, plotly, and shiny. 10 Saving and embedding HTML. Retrieved March 13, 2022, from https://plotly-r.com/saving.html 

[14] Zhu, H. (2021, February 19). Create awesome HTML table with knitr::kable and kableextra. Retrieved March 13, 2022, from http://haozhu233.github.io/kableExtra/awesome_table_in_html.html 

[15] Zach. (2021, November 29). How to perform a Granger-causality test in R. Statology. Retrieved March 13, 2022, from https://www.statology.org/granger-causality-test-in-r/ 

[16] Padav, P. (2021, August 24). Granger causality in time series explained with chicken and egg problem. Analytics Vidhya. Retrieved March 13, 2022, from https://www.analyticsvidhya.com/blog/2021/08/granger-causality-in-time-series-explained-using-chicken-and-egg-problem/ 

# Session info 
GitHub: https://github.com/X1xijiang/COVID-19_Data_Analysis_Project.git
```{r eval=FALSE, message=TRUE}
#install.packages("HH")
library(car)
#install.packages("kableExtra")
library(kableExtra)
library(stats)
library(lmtest)
covid <- read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/Latest reported counts of cases and death.csv")
vac <- read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/vaccination-data.csv")
# check NA
sum(is.na(covid))
sum(is.na(vac))

# delete NA in covid
sum(is.na(covid$`Cases - cumulative total per 100000 population`))#1 missing values
#covidc<- covid[-which(is.na(covid$`Cases - cumulative total per 100000 population`)), ]#remove those 1 missing values
sum(is.na(covid$`Cases - newly reported in last 7 days per 100000 population`))
sum(is.na(covid$`Deaths - cumulative total per 100000 population`))
sum(is.na(covid$`Deaths - newly reported in last 7 days per 100000 population`))
#238 data

#delete NA of 'PERSONS_FULLY_VACCINATED_PER100', 'TOTAL_VACCINATIONS_PER100', 'PERSONS_VACCINATED_1PLUS_DOSE_PER100', 'NUMBER_VACCINES_TYPES_USED' in vac
sum(is.na(vac$TOTAL_VACCINATIONS_PER100))
sum(is.na(vac$PERSONS_VACCINATED_1PLUS_DOSE_PER100))#3 missing values
vacc<- vac[-which(is.na(vac$PERSONS_VACCINATED_1PLUS_DOSE_PER100)), ]#remove those 3 missing values
sum(is.na(vacc$PERSONS_FULLY_VACCINATED_PER100))
sum(is.na(vacc$NUMBER_VACCINES_TYPES_USED))#3 missing values 
vacc<- vacc[-which(is.na(vacc$NUMBER_VACCINES_TYPES_USED)), ]
#222 data

#change name
covid$Name[which(covid$Name == 'Kosovo[1]')] <- "Kosovo"
covid$Name[which(covid$Name == "occupied Palestinian territory, including east Jerusalem")]<-"occupied Palestinian territory"
#merge data
data<-merge(covid,vacc,by.x = 'Name', by.y = 'COUNTRY') 
#221 data
data <- data[ , !names(data) %in% c("WHO.Region", "Cases...newly.reported.in.last.24.hours","Deaths...newly.reported.in.last.24.hours","TOTAL_VACCINATIONS","ISO3", "WHO_REGION", "DATA_SOURCE","DATE_UPDATED","VACCINES_USED","FIRST_VACCINE_DATE")]

#WHO-COVID-19-global-data
global<-read.csv("/Users/xixi/Library/Mobile Documents/com~apple~CloudDocs/207/Project/WHO-COVID-19-global-data.csv")
sum(is.na(global))
777/184149 
na.omit(global)
require(gridExtra)

library(plyr)
library(ggplot2)
Cases...newly.reported.in.last.7.days.per.100000.population<-arrange(data, -Cases...newly.reported.in.last.7.days.per.100000.population)
Country<-reorder(Cases...newly.reported.in.last.7.days.per.100000.population$Name,-Cases...newly.reported.in.last.7.days.per.100000.population$Cases...newly.reported.in.last.7.days.per.100000.population)
plot_1<-ggplot(Cases...newly.reported.in.last.7.days.per.100000.population,aes(x=Country,y=`Cases...newly.reported.in.last.7.days.per.100000.population`))+
  geom_point(color="black")+
  geom_line(aes(group=""), color="grey")+
  labs(x="")+
  theme(axis.title.x = element_blank(),
        axis.line.x= element_blank(),
        axis.text.x = element_blank())
plot_2 <- ggplot(data,aes(y=Cases...newly.reported.in.last.7.days.per.100000.population)) + geom_boxplot()
grid.arrange(plot_1, plot_2 ,ncol=2)
outliers <-boxplot(data$Cases...newly.reported.in.last.7.days.per.100000.population)$out
outliers2 <-boxplot(data$Cases...newly.reported.in.last.7.days.per.100000.population)$out
cnr<- data[-which(data$Cases...newly.reported.in.last.7.days.per.100000.population %in% outliers),]
summary(cnr$Cases...newly.reported.in.last.7.days.per.100000.population)
#define countries
covidnew<-data
#summary(data$Cases...newly.reported.in.last.7.days.per.100000.population)
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population <=69.194 )] <- "current mild epidemic"#<Mean
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population < 405.447 )] <- "current moderate epidemic"#Mean-3rd Qu.
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population < 8764.97 )] <- "current severe epidemic"#>3rd Qu.
#factor(covidnew$`Cases - newly reported in last 7 days per 100000 population`)
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population ==899.484 )] <- "current severe epidemic"
covidnew$Cases...newly.reported.in.last.7.days.per.100000.population[which(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population ==898.429 )] <- "current severe epidemic"
#count(covidnew$Cases...newly.reported.in.last.7.days.per.100000.population)

#factor(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
summary(data$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 >= 75.955 & covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 <= 123.710 )] <- "highly vaccinated"#>3rd Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 <=54.257 )] <- "lowly vaccinated"#<Mean
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 < 75.955 & covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 > 54.257)] <- "moderately vaccinated"# Mean.-3rd Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 ==8.491 )] <- "lowly vaccinated"#<1st Qu.
covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100[which(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100 ==8.525 )] <- "lowly vaccinated"#<1st Qu.

#factor(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
count(covidnew$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
Cases...cumulative.total_max10<-arrange(data, -Cases...cumulative.total)[1:10,]
Country<-reorder(Cases...cumulative.total_max10$Name,-Cases...cumulative.total_max10$Cases...cumulative.total)
Cases...newly.reported.in.last.7.days.per.100000.population.max10<-arrange(data, -Cases...newly.reported.in.last.7.days.per.100000.population)[1:10,]
Country2<-reorder(Cases...newly.reported.in.last.7.days.per.100000.population.max10$Name,-Cases...newly.reported.in.last.7.days.per.100000.population.max10$Cases...newly.reported.in.last.7.days.per.100000.population)
Deaths...cumulative.total_max10<-arrange(data, -Deaths...cumulative.total)[1:10,]
#bar plot of Cases...cumulative.total_max10
plot1<-ggplot(Cases...cumulative.total_max10,aes(x=Country,y=`Cases...cumulative.total`))+
  geom_bar(stat = 'identity',position="dodge")+
  geom_col(aes(fill=Name),show.legend=F)+  
  theme(axis.text.x = element_text(angle=60,hjust=1))
#bar plot of Cases...newly.reported.in.last.7.days.per.100000.population.max10
plot2<-ggplot(Cases...newly.reported.in.last.7.days.per.100000.population.max10,aes(x=Country2,y=`Cases...newly.reported.in.last.7.days.per.100000.population`))+
  geom_bar(stat = 'identity',position="dodge")+
  geom_col(aes(fill=Name),show.legend=F)+  
  theme(axis.text.x = element_text(angle=60,hjust=1))
grid.arrange(plot1, plot2 ,ncol=2)

global$Date_reported <- as.Date(global$Date_reported)
#number of new cases
a<-ggplot(global, aes(x=Date_reported, y=New_cases, color=WHO_region)) + 
  geom_bar(position = 'stack',stat="identity", width=0.6, color = "grey") + 
  #geom_col(position = 'stack', width = 0.6)+
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  ggtitle("new cases")

#number of cumulative cases
b<-ggplot(global, aes(x=Date_reported, y=Cumulative_cases, color=WHO_region)) + 
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
  ggtitle("cumulative cases")
grid.arrange(a,b,nrow=2)
#number of new deaths 
ggplot(global, aes(x=Date_reported, y=New_deaths, color=WHO_region)) + 
  geom_col(position = 'stack', width = 0.6)+
  geom_line()+scale_x_date(name="Monthly",date_breaks  ="1 month",date_labels="%Y-%m") +  
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))

#Distribution of the number of vaccine types used per country, territory, area
par(pin = c(6,4.5))
freq <- table(data$NUMBER_VACCINES_TYPES_USED)
class<-levels(data$NUMBER_VACCINES_TYPES_USED)
piepercent <- round(freq/sum(freq)*100,2)
pie(freq,labels = paste(c("1 type:","2 types:","3 types:","4 types:","5 types:","6 types:","7 types:","8 types:","9 types:","11 types:"),piepercent,"%"))

# Exploratory analysis
require(dplyr)
library(gplots)
df<-data.frame(data$Cases...newly.reported.in.last.7.days.per.100000.population,covidnew[ ,names(covidnew) %in% c("PERSONS_VACCINATED_1PLUS_DOSE_PER100","NUMBER_VACCINES_TYPES_USED")])
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=as.factor(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=as.factor(df$NUMBER_VACCINES_TYPES_USED)
df <- df%>%filter(NUMBER_VACCINES_TYPES_USED!="9")
df <- df%>%filter(NUMBER_VACCINES_TYPES_USED!="11")
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=unlist(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=unlist(df$NUMBER_VACCINES_TYPES_USED)
names(df)<-c("nrc","pv1","nct")
df$PERSONS_VACCINATED_1PLUS_DOSE_PER100=unlist(df$PERSONS_VACCINATED_1PLUS_DOSE_PER100)
df$NUMBER_VACCINES_TYPES_USED=unlist(df$NUMBER_VACCINES_TYPES_USED)
names(df)<-c("nrc","pv1","nct")

## Levene Test:Homogeneity of variance
dt<-leveneTest(nrc~pv1*nct,data=df)
dt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))

dff<-df
dff$`nrc`<-log10(1+(dff$nrc)^(1/2))
kt<-leveneTest(nrc~pv1*nct,data=dff)
kt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
#QQ-plot :Normality of the distribution
par(mfrow = c(1, 2))
qqPlot(lm(nrc~pv1, data = dff), simulate = TRUE, main = 'QQ Plot', labels = FALSE)
qqPlot(lm(nrc~nct, data = dff), simulate = TRUE, main = 'QQ Plot', labels = FALSE)
#sum(is.na(df))
par(mfrow=c(1,2))
# Main effect plot for ingredient 1
plotmeans(nrc~pv1,data=dff,xlab="vaccination level",ylab="weekly newly cases per 100000",
          main="Main  effect, vaccination level",cex.lab=1.5) 
# Main effect plot for ingredient 2
plotmeans(nrc~nct,data=dff,xlab="vaccines types",ylab="weekly newly cases per 100000", 
          main="Main  effect, vaccines types",cex.lab=1.5) 
#Interaction plot
interaction.plot( dff$nct,dff$pv1, dff$nrc,cex.lab=1.5,ylab="weekly newly cases per 100000",xlab='vaccines types')
# Test for interactions 
full_model=lm(nrc~as.factor(dff$pv1)+as.factor(dff$nct)+as.factor(dff$pv1)*as.factor(dff$nct),data=dff);
reduced_model=lm(nrc~as.factor(dff$pv1)+as.factor(dff$nct),data=dff);
at<-anova(reduced_model,full_model)
at %>%
  kbl() %>%
  kable_material(c("striped", "hover"))

# Fit the chosen model:
sig.level=0.05;
anova.fit<-aov(nrc~pv1+nct,data=dff)
summary(anova.fit)

bt<- data.frame("row1" = c(" ", "Df", "Sum Sq", "Mean Sq", "F value", "Pr(>F)"), "row2" = c("pv1", "2", "14.48", "7.241", "34.782","9.31e-14 ***"))
variable = c("pv1","nct","Residuals")
Df = c(2,7,208)
Sum_Sq = c(14.48,8.30,43.30)
Mean_Sq=c(7.241,1.186,0.208)
F_value=c(34.782,5.695," ")
Pr=c("9.31e-14 ***","4.90e-06 ***"," ")
bt = data.frame(variable,Df,Sum_Sq,Mean_Sq,F_value,Pr);
bt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))

par(mfrow=c(2,2))
# Obtain the residuals from the ANOVA fit
residuals=anova.fit$residuals;
hist(residuals)
# Plot the residuals (or the other two versions) against fitted values
plot(residuals~anova.fit$fitted.values,type='p',pch=16,cex=1.5,xlab="Fitted values",ylab="Residuals")
# Stem-leaf plot  (or use histogram, or qq-plot )
qqnorm(residuals);qqline(residuals)

gt<-grangertest(`Cases...newly.reported.in.last.7.days` ~ `PERSONS_VACCINATED_1PLUS_DOSE_PER100`, order = 2, data =data)
gt %>%
  kbl() %>%
  kable_material(c("striped", "hover"))
```
